<!DOCTYPE html>
<html>

<head>
    <title>WebSocket Test - Sopa y Carbon</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
        }

        #messages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9f9f9;
        }

        input[type="text"] {
            padding: 8px;
            width: 300px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>WebSocket Test - Vercy Motos</h1>

        <div class="status info">
            <strong>URL del WebSocket:</strong> <span id="wsUrl"></span>
        </div>

        <div class="status" id="connectionStatus">
            <strong>Estado:</strong> Desconectado
        </div>

        <div>
            <button onclick="connect()">Conectar WebSocket</button>
            <button onclick="disconnect()">Desconectar</button>
            <button onclick="testApiEndpoint()">Test API WebSocket</button>
        </div>

        <div>
            <h3>Enviar mensaje de prueba:</h3>
            <input type="text" id="messageInput" placeholder="Mensaje de prueba" value="Hola WebSocket">
            <button onclick="sendTestMessage()">Enviar a /app/test</button>
            <button onclick="sendEcho()">Enviar Echo</button>
        </div>

        <h3>Mensajes recibidos:</h3>
        <div id="messages"></div>

        <div>
            <button onclick="clearMessages()">Limpiar mensajes</button>
            <button onclick="subscribeToPedidos()">Suscribirse a /topic/pedidos</button>
            <button onclick="subscribeToMesas()">Suscribirse a /topic/mesas</button>
        </div>
    </div>

    <!-- CDN de SockJS y STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

    <script>
        let stompClient = null;
        let socket = null;

        // Detectar la URL base
        const baseUrl = window.location.protocol + '//' + window.location.host;
        const wsUrl = baseUrl + '/ws';
        document.getElementById('wsUrl').textContent = wsUrl;

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = 'status ' + type;
            statusDiv.innerHTML = '<strong>Estado:</strong> ' + message;
        }

        function addMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            messagesDiv.innerHTML += '[' + timestamp + '] ' + message + '<br>';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function connect() {
            try {
                updateStatus('Conectando...', 'info');
                addMessage('Intentando conectar a: ' + wsUrl);

                // Crear conexiÃ³n SockJS
                socket = new SockJS(wsUrl);
                stompClient = new StompJs.Client({
                    webSocketFactory: () => socket,
                    debug: (str) => {
                        console.log('STOMP Debug:', str);
                        addMessage('Debug: ' + str);
                    },
                    onConnect: (frame) => {
                        updateStatus('Conectado exitosamente', 'success');
                        addMessage('âœ… Conectado a WebSocket');

                        // Suscribirse automÃ¡ticamente a algunos topics
                        stompClient.subscribe('/topic/test', (message) => {
                            addMessage('ðŸ“¨ Test: ' + message.body);
                        });

                        stompClient.subscribe('/topic/echo', (message) => {
                            addMessage('ðŸ”„ Echo: ' + message.body);
                        });
                    },
                    onStompError: (frame) => {
                        updateStatus('Error STOMP: ' + frame.headers['message'], 'error');
                        addMessage('âŒ Error STOMP: ' + frame.headers['message']);
                    },
                    onWebSocketError: (error) => {
                        updateStatus('Error WebSocket: ' + error, 'error');
                        addMessage('âŒ Error WebSocket: ' + error);
                    },
                    onDisconnect: () => {
                        updateStatus('Desconectado', 'info');
                        addMessage('ðŸ”Œ Desconectado del WebSocket');
                    }
                });

                stompClient.activate();

            } catch (error) {
                updateStatus('Error al conectar: ' + error.message, 'error');
                addMessage('âŒ Error al conectar: ' + error.message);
            }
        }

        function disconnect() {
            if (stompClient) {
                stompClient.deactivate();
                stompClient = null;
                socket = null;
                updateStatus('Desconectado', 'info');
                addMessage('ðŸ”Œ Desconectado manualmente');
            }
        }

        function sendTestMessage() {
            if (stompClient && stompClient.connected) {
                const message = document.getElementById('messageInput').value;
                stompClient.publish({
                    destination: '/app/test',
                    body: message
                });
                addMessage('ðŸ“¤ Enviado a /app/test: ' + message);
            } else {
                addMessage('âŒ No conectado. Conecta primero.');
            }
        }

        function sendEcho() {
            if (stompClient && stompClient.connected) {
                const message = document.getElementById('messageInput').value;
                stompClient.publish({
                    destination: '/app/echo',
                    body: message
                });
                addMessage('ðŸ“¤ Enviado a /app/echo: ' + message);
            } else {
                addMessage('âŒ No conectado. Conecta primero.');
            }
        }

        function subscribeToPedidos() {
            if (stompClient && stompClient.connected) {
                stompClient.subscribe('/topic/pedidos', (message) => {
                    addMessage('ðŸ½ï¸ Pedido: ' + message.body);
                });
                addMessage('âœ… Suscrito a /topic/pedidos');
            } else {
                addMessage('âŒ No conectado. Conecta primero.');
            }
        }

        function subscribeToMesas() {
            if (stompClient && stompClient.connected) {
                stompClient.subscribe('/topic/mesas', (message) => {
                    addMessage('ðŸª‘ Mesa: ' + message.body);
                });
                addMessage('âœ… Suscrito a /topic/mesas');
            } else {
                addMessage('âŒ No conectado. Conecta primero.');
            }
        }

        function testApiEndpoint() {
            fetch(baseUrl + '/api/test-websocket')
                .then(response => response.json())
                .then(data => {
                    addMessage('ðŸŒ API Test: ' + JSON.stringify(data));
                })
                .catch(error => {
                    addMessage('âŒ Error API Test: ' + error.message);
                });
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        // Auto-conectar al cargar la pÃ¡gina (opcional)
        // window.onload = () => connect();
    </script>
</body>

</html>